generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// 用户模型 - 针对中国用户优化
model User {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email              String    @unique @db.VarChar(255)
  name               String?   @db.VarChar(100) // 单一姓名字段，支持中文
  avatar             String?   @db.VarChar(500)
  phone              String?   @unique @db.VarChar(20) // 手机号，支持+86格式
  passwordSalt       String?   @db.VarChar(64) // 密码盐值，客户端生成
  passwordHash       String?   @db.VarChar(128) // 密码哈希，客户端计算
  passwordIterations Int?      @default(100000) // PBKDF2迭代次数
  isEmailVerified    Boolean   @default(false)
  isPhoneVerified    Boolean   @default(false)
  isActive           Boolean   @default(true)
  lastLoginAt        DateTime? @db.Timestamptz(6)
  createdAt          DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime  @default(now()) @db.Timestamptz(6)

  // 关联关系
  refreshTokens      RefreshToken[]
  emailVerifications EmailVerification[]
  phoneVerifications PhoneVerification[]
  passwordResets     PasswordReset[]
  accounts           Account[]
  sessions           Session[]
  wechatAccounts     WechatAccount[]

  @@index([email])
  @@index([phone])
  @@index([isActive])
  @@index([isEmailVerified])
  @@index([isPhoneVerified])
  @@map("users")
}

// 刷新令牌模型 - gRPC优化
model RefreshToken {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  token      String   @unique @db.VarChar(500)
  userId     String   @db.Uuid
  expiresAt  DateTime @db.Timestamptz(6)
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  isRevoked  Boolean  @default(false)
  clientInfo Json? // 客户端信息（IP、User-Agent等）

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([isRevoked])
  @@map("refresh_tokens")
}

// 邮箱验证模型
model EmailVerification {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String   @db.VarChar(255)
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime @db.Timestamptz(6)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  userId    String   @db.Uuid

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([token])
  @@index([expiresAt])
  @@map("email_verifications")
}

// 手机号验证模型 - 新增
model PhoneVerification {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  phone     String   @db.VarChar(20)
  code      String   @db.VarChar(10) // 6位数字验证码
  type      String   @default("REGISTER") @db.VarChar(20) // REGISTER, LOGIN, RESET_PASSWORD
  attempts  Int      @default(0) // 验证尝试次数
  expiresAt DateTime @db.Timestamptz(6)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  userId    String?  @db.Uuid // 可选，用于已注册用户

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([phone])
  @@index([code])
  @@index([expiresAt])
  @@index([type])
  @@map("phone_verifications")
}

// 密码重置模型 - 增强安全
model PasswordReset {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String   @db.VarChar(255)
  phone     String?  @db.VarChar(20) // 支持手机号重置
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime @db.Timestamptz(6)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  userId    String   @db.Uuid
  isUsed    Boolean  @default(false) // 标记是否已使用

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([phone])
  @@index([token])
  @@index([expiresAt])
  @@index([isUsed])
  @@map("password_resets")
}

// OAuth账户信息模型
model Account {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String   @db.Uuid
  type              String   @db.VarChar(50) // "oauth", "email", "phone", "wechat"
  provider          String   @db.VarChar(50) // "google", "github", "wechat"
  providerAccountId String   @db.VarChar(255)
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?  @db.VarChar(50)
  scope             String?  @db.Text
  id_token          String?  @db.Text
  session_state     String?  @db.Text
  createdAt         DateTime @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@index([provider])
  @@map("accounts")
}

// 会话管理模型 - gRPC优化
model Session {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionToken String   @unique @db.VarChar(255)
  userId       String   @db.Uuid
  expires      DateTime @db.Timestamptz(6)
  createdAt    DateTime @default(now()) @db.Timestamptz(6)
  lastActivity DateTime @default(now()) @db.Timestamptz(6)
  clientInfo   Json? // 客户端信息
  isActive     Boolean  @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([expires])
  @@index([isActive])
  @@map("sessions")
}

// 微信账户模型 - 新增
model WechatAccount {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String    @db.Uuid
  wechatOpenId  String    @unique @db.VarChar(100)
  wechatUnionId String?   @db.VarChar(100) // 开放平台唯一标识
  nickname      String?   @db.VarChar(100) // 微信昵称
  avatar        String?   @db.VarChar(500) // 微信头像
  sex           Int? // 性别：1男性，2女性，0未知
  province      String?   @db.VarChar(50) // 省份
  city          String?   @db.VarChar(50) // 城市
  country       String?   @db.VarChar(50) // 国家
  accessToken   String?   @db.Text // 访问令牌
  refreshToken  String?   @db.Text // 刷新令牌
  expiresAt     DateTime? @db.Timestamptz(6) // 令牌过期时间
  scope         String?   @db.Text // 授权范围
  createdAt     DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([wechatOpenId])
  @@index([wechatUnionId])
  @@map("wechat_accounts")
}

// 登录日志模型 - 新增，用于安全审计
model LoginLog {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String?  @db.Uuid
  email         String?  @db.VarChar(255)
  phone         String?  @db.VarChar(20)
  loginType     String   @db.VarChar(20) // EMAIL, PHONE, OAUTH, WECHAT
  provider      String?  @db.VarChar(50) // OAuth提供商
  ip            String   @db.VarChar(45) // 支持IPv6
  userAgent     String?  @db.Text
  success       Boolean
  failureReason String?  @db.VarChar(255) // 失败原因
  createdAt     DateTime @default(now()) @db.Timestamptz(6)

  @@index([userId])
  @@index([email])
  @@index([phone])
  @@index([loginType])
  @@index([success])
  @@index([createdAt])
  @@map("login_logs")
}

// 密码历史模型 - 新增，防止密码重复使用
model PasswordHistory {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String   @db.Uuid
  passwordHash String   @db.VarChar(128)
  passwordSalt String   @db.VarChar(64)
  iterations   Int      @default(100000)
  createdAt    DateTime @default(now()) @db.Timestamptz(6)

  @@index([userId])
  @@index([createdAt])
  @@map("password_history")
}
