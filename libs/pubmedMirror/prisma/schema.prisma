// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Main citation model - represents a MedlineCitation
model MedlineCitation {
  pmid           Int       @id
  dateCompleted  DateTime?
  dateRevised    DateTime
  citationSubset String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  article      Article?
  journal      Journal       @relation(fields: [journalId], references: [id])
  chemicals    Chemical[]
  meshHeadings MeshHeading[]
  pubmedData   PubMedData?
  journalId    Int

  @@index([dateCompleted])
  @@index([dateRevised])
  @@map("medline_citations")
}

// Article information
model Article {
  id               Int      @id @default(autoincrement())
  pmid             Int      @unique
  journal          Journal  @relation(fields: [journalId], references: [id])
  articleTitle     String   @db.Text
  pagination       String? // Stores MedlinePgn
  language         String?
  publicationTypes String[] // Stores PublicationType array as text strings
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  medlineCitation MedlineCitation @relation(fields: [pmid], references: [pmid], onDelete: Cascade)
  articleDetail   ArticleDetail?
  authors         Author[]
  grants          Grant[]
  journalId       Int

  @@index([pmid])
  @@map("articles")
}

// Author information
model Author {
  id          Int      @id @default(autoincrement())
  articleId   Int
  lastName    String?
  foreName    String?
  initials    String?
  affiliation String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([articleId])
  @@map("authors")
}

// Grant information
model Grant {
  id        Int      @id @default(autoincrement())
  articleId Int
  grantId   String?
  acronym   String?
  agency    String?
  country   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([articleId])
  @@map("grants")
}

model Journal {
  id               Int               @id @default(autoincrement())
  country          String?
  title            String?
  medlineTA        String?
  ISOAbbreviation  String?
  nlmUniqueId      Int               @unique
  issnLinking      String?
  // medlineJournalInfos MedlineJournalInfo[]
  articles         Article[]
  medlineCitations MedlineCitation[]
}

// // Medline Journal Info
// model MedlineJournalInfo {
//   id        Int      @id @default(autoincrement())
//   pmid      Int      @unique
//   journal   Journal  @relation(fields: [journalId], references: [id])
//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt

//   // Relations
//   medlineCitation MedlineCitation @relation(fields: [pmid], references: [pmid], onDelete: Cascade)
//   journalId       Int

//   @@index([pmid])
//   @@map("medline_journal_info")
// }

// Chemical information
model Chemical {
  id              Int      @id @default(autoincrement())
  pmid            Int
  registryNumber  String
  nameOfSubstance String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  medlineCitation MedlineCitation @relation(fields: [pmid], references: [pmid], onDelete: Cascade)

  @@index([pmid])
  @@index([registryNumber])
  @@map("chemicals")
}

// MeSH Heading
model MeshHeading {
  id             Int      @id @default(autoincrement())
  pmid           Int
  descriptorName String
  qualifierNames Json // Stores array of qualifier names
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  medlineCitation MedlineCitation @relation(fields: [pmid], references: [pmid], onDelete: Cascade)

  @@index([pmid])
  @@index([descriptorName])
  @@map("mesh_headings")
}

// PubMed Data
model PubMedData {
  id                Int      @id @default(autoincrement())
  pmid              Int      @unique
  publicationStatus String?
  articleIds        Json // Stores ArticleId array
  history           Json // Stores PubMedPubDate array
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  medlineCitation MedlineCitation @relation(fields: [pmid], references: [pmid], onDelete: Cascade)

  @@index([pmid])
  @@map("pubmed_data")
}

// Article Detail from PubMed detail page
model ArticleDetail {
  id                          Int      @id @default(autoincrement())
  pmid                        Int      @unique
  doi                         String?
  title                       String   @db.Text
  abstract                    String?  @db.Text
  conflictOfInterestStatement String?  @db.Text
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt

  // Relations
  article            Article?                          @relation(fields: [pmid], references: [pmid], onDelete: Cascade)
  authors            ArticleDetailAuthor[]
  affiliations       ArticleDetailAffiliation[]
  keywords           ArticleDetailKeyword[]
  similarArticles    ArticleDetailSimilarArticle[]
  references         ArticleDetailReference[]
  publicationTypes   ArticleDetailPublicationType[]
  meshTerms          ArticleDetailMeshTerm[]
  relatedInformation ArticleDetailRelatedInformation[]
  fullTextSources    ArticleDetailFullTextSource[]
  journalInfo        ArticleDetailJournalInfo?

  @@index([pmid])
  @@index([doi])
  @@map("article_details")
}

// Author with detailed info from detail page
model ArticleDetailAuthor {
  id              Int      @id @default(autoincrement())
  articleDetailId Int
  name            String
  position        Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  articleDetail ArticleDetail                    @relation(fields: [articleDetailId], references: [id], onDelete: Cascade)
  affiliations  ArticleDetailAuthorAffiliation[]

  @@index([articleDetailId])
  @@map("article_detail_authors")
}

// Affiliation linked to author
model ArticleDetailAuthorAffiliation {
  id          Int      @id @default(autoincrement())
  authorId    Int
  institution String?  @db.Text
  city        String?
  country     String?
  email       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  author ArticleDetailAuthor @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@map("article_detail_author_affiliations")
}

// Affiliation from article level
model ArticleDetailAffiliation {
  id              Int      @id @default(autoincrement())
  articleDetailId Int
  institution     String?  @db.Text
  city            String?
  country         String?
  email           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  articleDetail ArticleDetail @relation(fields: [articleDetailId], references: [id], onDelete: Cascade)

  @@index([articleDetailId])
  @@map("article_detail_affiliations")
}

// Keyword from detail page
model ArticleDetailKeyword {
  id              Int      @id @default(autoincrement())
  articleDetailId Int
  text            String
  isMeSH          Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  articleDetail ArticleDetail @relation(fields: [articleDetailId], references: [id], onDelete: Cascade)

  @@index([articleDetailId])
  @@index([text])
  @@map("article_detail_keywords")
}

// Similar article
model ArticleDetailSimilarArticle {
  id              Int      @id @default(autoincrement())
  articleDetailId Int
  pmid            String
  title           String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  articleDetail ArticleDetail @relation(fields: [articleDetailId], references: [id], onDelete: Cascade)

  @@index([articleDetailId])
  @@index([pmid])
  @@map("article_detail_similar_articles")
}

// Reference
model ArticleDetailReference {
  id              Int      @id @default(autoincrement())
  articleDetailId Int
  pmid            String?
  citation        String   @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  articleDetail ArticleDetail @relation(fields: [articleDetailId], references: [id], onDelete: Cascade)

  @@index([articleDetailId])
  @@map("article_detail_references")
}

// Publication type
model ArticleDetailPublicationType {
  id              Int      @id @default(autoincrement())
  articleDetailId Int
  type            String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  articleDetail ArticleDetail @relation(fields: [articleDetailId], references: [id], onDelete: Cascade)

  @@index([articleDetailId])
  @@map("article_detail_publication_types")
}

// MeSH term
model ArticleDetailMeshTerm {
  id              Int      @id @default(autoincrement())
  articleDetailId Int
  text            String
  isMeSH          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  articleDetail ArticleDetail @relation(fields: [articleDetailId], references: [id], onDelete: Cascade)

  @@index([articleDetailId])
  @@index([text])
  @@map("article_detail_mesh_terms")
}

// Related information (key-value pairs)
model ArticleDetailRelatedInformation {
  id              Int      @id @default(autoincrement())
  articleDetailId Int
  category        String
  text            String
  url             String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  articleDetail ArticleDetail @relation(fields: [articleDetailId], references: [id], onDelete: Cascade)

  @@index([articleDetailId])
  @@index([category])
  @@map("article_detail_related_information")
}

// Full text source
model ArticleDetailFullTextSource {
  id              Int      @id @default(autoincrement())
  articleDetailId Int
  name            String
  url             String
  type            String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  articleDetail ArticleDetail @relation(fields: [articleDetailId], references: [id], onDelete: Cascade)

  @@index([articleDetailId])
  @@map("article_detail_full_text_sources")
}

// Journal info from detail page
model ArticleDetailJournalInfo {
  id              Int      @id @default(autoincrement())
  articleDetailId Int      @unique
  title           String?
  volume          String?
  issue           String?
  pages           String?
  pubDate         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  articleDetail ArticleDetail @relation(fields: [articleDetailId], references: [id], onDelete: Cascade)

  @@index([articleDetailId])
  @@map("article_detail_journal_info")
}

// Sync tracking for baseline files
model BaselineSync {
  id           Int      @id @default(autoincrement())
  fileName     String   @unique
  fileDate     String
  recordsCount Int
  syncedAt     DateTime @default(now())
  status       String   @default("completed") // completed, failed, in_progress
  errorMessage String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([fileDate])
  @@index([status])
  @@map("baseline_syncs")
}
